name: Build Polyphone for Linux aarch64

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        required: true
        default: '0.0.0'
        type: string
      
env:
  QT_VERSION: '6.6.2'

jobs:
  build-linux-aarch64:
    environment: production
    runs-on: ubuntu-24.04-arm
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update metainfo XML
        run: |
          SHORT_VERSION=$(echo "${{ inputs.tag }}" | grep -oE '^[0-9]+\.[0-9]+')
          TODAY=$(date +%F)
          URL="https://www.polyphone.io/en/news/version-$SHORT_VERSION"
          METAFILE="packaging/io.polyphone.polyphone.metainfo.xml"
          sed -i -E \
            -e "s/(<release[^>]*version=\")[^\"]+/\1$SHORT_VERSION/" \
            -e "s/(<release[^>]*date=\")[^\"]+/\1$TODAY/" \
            -e "s|(</release>.*<url>)[^<]+|\1$URL|" \
            "$METAFILE"
        
      - name: Update version info in polyphone.pro
        run: |
          TAG="${{ inputs.tag }}"
          SOFT_VERSION="${TAG%%-*}"
          if [[ "$TAG" == *"-"* ]]; then
            IDENTIFIER="${TAG#*-}"
          else
            IDENTIFIER=""
          fi
          CURRENT_YEAR=$(date +%Y)

          echo "Tag: $TAG"
          echo "SOFT_VERSION: $SOFT_VERSION"
          echo "IDENTIFIER: $IDENTIFIER"
          echo "CURRENT_YEAR: $CURRENT_YEAR"

          sed -i 's/SOFT_VERSION=\\\\\\\"[^\\]*\\\\\\\"/SOFT_VERSION=\\\\\\\"'${SOFT_VERSION}'\\\\\\\"/' sources/polyphone.pro
          sed -i 's/IDENTIFIER=\\\\\\\"[^\\]*\\\\\\\"/IDENTIFIER=\\\\\\\"'${IDENTIFIER}'\\\\\\\"/' sources/polyphone.pro
          sed -i 's/CURRENT_YEAR=\\\\\\\"[^\\]*\\\\\\\"/CURRENT_YEAR=\\\\\\\"'${CURRENT_YEAR}'\\\\\\\"/' sources/polyphone.pro

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            qt6-base-dev \
            qt6-svg-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            qt6-l10n-tools \
            libasound2-dev \
            libjack-jackd2-dev \
            libsndfile1-dev \
            libogg-dev \
            libvorbis-dev \
            libflac-dev \
            zlib1g-dev \
            libssl-dev \
            librtaudio-dev \
            librtmidi-dev \
            libstk-dev
            
      - name: Configure with qmake
        run: |
          cd sources
          qmake6 polyphone.pro \
            PREFIX=/usr \
            CONFIG+=release \
            DEFINES+=USE_LOCAL_RTAUDIO

      - name: Build Polyphone
        run: |
          cd sources
          make -j$(nproc)

      - name: Create AppImage
        env:
          OUTPUT: Polyphone_${{ inputs.tag }}-linux_aarch64.AppImage
          EXTRA_PLATFORM_PLUGINS: "libqwayland-egl.so;libqwayland-generic.so"
          EXTRA_QT_PLUGINS: "waylandcompositor"
        run: |
          # Install linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-aarch64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-aarch64.AppImage
          chmod +x linuxdeploy*.AppImage
          
          # Create AppDir structure
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/512x512/apps
          
          cp sources/bin/polyphone AppDir/usr/bin/
          cp packaging/io.polyphone.polyphone.desktop AppDir/usr/share/applications/
          cp sources/resources/polyphone.png AppDir/usr/share/icons/hicolor/512x512/apps/
          
          # SSL
          cp /usr/lib/aarch64-linux-gnu/libssl.so.3 AppDir/usr/lib/
          cp /usr/lib/aarch64-linux-gnu/libcrypto.so.3 AppDir/usr/lib/
          
          # Generate the AppImage
          export LINUXDEPLOY_EXTRA_LIBS=$(ldd sources/bin/polyphone | grep -E 'libssl|libcrypto' | awk '{print $3}' | tr '\n' ':')
          ./linuxdeploy-aarch64.AppImage --appdir AppDir --plugin qt --output appimage

      - name: Upload artifact
        id: upload-artifact
        uses: actions/upload-artifact@v4
        with:
          name: polyphone-linux-aarch64-appimage
          path: Polyphone*.AppImage
          retention-days: 7
          if-no-files-found: error
          
      - name: Sign the artifact
        uses: signpath/github-action-submit-signing-request@v2
        with:
          api-token: ${{ secrets.SIGNPATH_API_TOKEN }}
          organization-id: ${{ vars.SIGNPATH_ORGANIZATION_ID }}
          project-slug: polyphone
          signing-policy-slug: test-signing
          wait-for-completion: true
          github-artifact-id: '${{ steps.upload-artifact.outputs.artifact-id }}'
          output-artifact-directory: 'signed'

      - name: Upload the signed artifact
        uses: actions/upload-artifact@v4
        with:
          path: "signed/*.AppImage"
          name: polyphone-linux-aarch64-appimage-signed
          if-no-files-found: error
